# NetProbe - é«˜æ€§èƒ½ eBPF ç½‘ç»œç›‘æ§ç³»ç»Ÿ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

NetProbe æ˜¯ä¸€ä¸ªåŸºäº **Cilium/eBPF** åº“å®ç°çš„äº‘åŸç”Ÿç½‘ç»œç›‘æ§ç³»ç»Ÿï¼Œä¸“ä¸º Kubernetes ç¯å¢ƒè®¾è®¡ã€‚å®ƒåˆ©ç”¨ eBPF æŠ€æœ¯åœ¨å†…æ ¸ç©ºé—´è¿›è¡Œé«˜æ•ˆçš„ç½‘ç»œæ•°æ®åŒ…å¤„ç†ï¼Œæä¾›å®æ—¶ã€ä½å¼€é”€çš„ç½‘ç»œæµé‡ç›‘æ§å’Œå®‰å…¨åˆ†æã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸš€ é«˜æ€§èƒ½ç›‘æ§
- **é›¶æ‹·è´å¤„ç†**ï¼šåŸºäº eBPF çš„å†…æ ¸çº§æ•°æ®åŒ…å¤„ç†
- **å¤šå±‚ç›‘æ§**ï¼šæ”¯æŒ XDPã€TC (Traffic Control) å’Œ Socket å±‚ç›‘æ§
- **å®æ—¶ç»Ÿè®¡**ï¼šæ¯«ç§’çº§ç½‘ç»œæµé‡ç»Ÿè®¡å’Œå¼‚å¸¸æ£€æµ‹

### ğŸ”’ å®‰å…¨åˆ†æ
- **ç«¯å£æ‰«ææ£€æµ‹**ï¼šè¯†åˆ«å¼‚å¸¸ç«¯å£æ‰«æè¡Œä¸º
- **å¼‚å¸¸è¿æ¥ç›‘æ§**ï¼šæ£€æµ‹å¯ç–‘ç½‘ç»œè¿æ¥æ¨¡å¼
- **DDoS é˜²æŠ¤**ï¼šå®æ—¶æµé‡åˆ†æå’Œæ”»å‡»æ£€æµ‹

### ğŸ›ï¸ äº‘åŸç”Ÿè®¾è®¡
- **Kubernetes é›†æˆ**ï¼šåŸç”Ÿæ”¯æŒå®¹å™¨ç½‘ç»œç›‘æ§
- **Prometheus å…¼å®¹**ï¼šæ ‡å‡† metrics æ ¼å¼å¯¼å‡º
- **å®¹å™¨æ„ŸçŸ¥**ï¼šPod å’Œ Service çº§åˆ«çš„ç½‘ç»œå¯è§†åŒ–

### ï¿½ å¼€å‘å‹å¥½
- **çº¯ Go å®ç°**ï¼šä½¿ç”¨ cilium/ebpf åº“ï¼Œæ— éœ€ CGO
- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥ï¼Œé¿å…è¿è¡Œæ—¶é—®é¢˜
- **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäº Ring Buffer çš„é«˜æ•ˆäº‹ä»¶å¤„ç†ç³»ç»Ÿ

## ğŸ“ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ç©ºé—´ (User Space)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  cmd/agent/           â”‚  pkg/metrics/        â”‚  pkg/collector/   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   NetProbe      â”‚   â”‚  â”‚   Prometheus    â”‚  â”‚  â”‚ TC Collector â”‚ â”‚
â”‚  â”‚   Agent         â”‚â—„â”€â”€â”¤  â”‚   Metrics       â”‚â—„â”€â”¤  â”‚              â”‚ â”‚
â”‚  â”‚                 â”‚   â”‚  â”‚   Server        â”‚  â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚            â”‚           â”‚           â”‚         â–²        â”‚
â”‚           â–¼            â”‚           â–¼           â”‚         â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚        â”‚
â”‚  â”‚            pkg/ebpf/manager.go             â”‚ â”‚         â”‚        â”‚
â”‚  â”‚          (eBPF ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç†)            â”‚ â”‚         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â–¼                               â”‚        â”‚
â”‚                   å†…æ ¸ç©ºé—´ (Kernel Space)                â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ebpf/network/monitor.c                               â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   XDP Hook      â”‚ â”‚   TC Ingress    â”‚ â”‚ TC Egress   â”‚    â”‚   â”‚
â”‚  â”‚                 â”‚ â”‚   Hook          â”‚ â”‚ Hook        â”‚    â”‚   â”‚
â”‚  â”‚ ç½‘å¡é©±åŠ¨å±‚æ‹¦æˆª   â”‚ â”‚                 â”‚ â”‚             â”‚    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                   â”‚                   â”‚    â”‚        â”‚
â”‚           â–¼                   â–¼                   â–¼    â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    eBPF Maps                              â”‚ â”‚
â”‚  â”‚  packet_stats â”‚ flow_stats â”‚ tc_device_stats              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘
1. **æ•°æ®åŒ…æ•è·**ï¼šeBPF ç¨‹åºåœ¨ XDP/TC å±‚æ‹¦æˆªç½‘ç»œæ•°æ®åŒ…
2. **ç»Ÿè®¡æ›´æ–°**ï¼šä½¿ç”¨åŸå­æ“ä½œæ›´æ–° eBPF Maps ä¸­çš„ç»Ÿè®¡æ•°æ®
3. **æ•°æ®æ”¶é›†**ï¼šGo æ”¶é›†å™¨å®šæœŸè¯»å– eBPF Maps æ•°æ®
4. **æŒ‡æ ‡è®¡ç®—**ï¼šè®¡ç®—å®æ—¶é€Ÿç‡å’Œèšåˆç»Ÿè®¡ä¿¡æ¯
5. **æŒ‡æ ‡å¯¼å‡º**ï¼šé€šè¿‡ Prometheus æ ¼å¼ HTTP æ¥å£æš´éœ²æŒ‡æ ‡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux å†…æ ¸ 4.18+ (æ¨è 5.4+)
- **å¼€å‘ç¯å¢ƒ**ï¼šGo 1.21+
- **æƒé™è¦æ±‚**ï¼šRoot æƒé™ï¼ˆç”¨äºåŠ è½½ eBPF ç¨‹åºï¼‰
- **ä¾èµ–å·¥å…·**ï¼šclang, llvm, libbpf

### 2. ç¼–è¯‘å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/Haibara-Ai97/netprobe.git
cd netprobe

# å®‰è£… Go ä¾èµ–
go mod tidy

# ç¼–è¯‘ eBPF ç¨‹åº
make build-ebpf

# ç¼–è¯‘ NetProbe Agent
make build

# æˆ–è€…ä½¿ç”¨è„šæœ¬ä¸€é”®ç¼–è¯‘
./scripts/build_ebpf.sh
```

### 3. è¿è¡Œç›‘æ§

```bash
# å¯åŠ¨ NetProbe Agent (éœ€è¦ root æƒé™)
sudo ./bin/netprobe-agent \
  --metrics-port=8081 \
  --collect-interval=5s \
  --interface-filter=eth0,wlan0

# æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
curl http://localhost:8081/metrics

# æŒ‡å®šç½‘ç»œæ¥å£ç›‘æ§
sudo NETWORK_INTERFACE=eth0 ./bin/netprobe-agent
```

### 4. Kubernetes éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
kubectl apply -f deploy/agent.yaml

# æŸ¥çœ‹ Pod çŠ¶æ€
kubectl get pods -l app=netprobe-agent

# æŸ¥çœ‹ç›‘æ§æ•°æ®
kubectl port-forward service/netprobe-metrics 8081:8081
curl http://localhost:8081/metrics
```

## ğŸ”§ æ ¸å¿ƒ API ä¸ä½¿ç”¨

### eBPF ç®¡ç†å™¨

```go
import "github.com/Haibara-Ai97/netprobe/pkg/ebpf"

// åˆ›å»º eBPF ç®¡ç†å™¨
manager, err := ebpf.NewManager()
if err != nil {
    return err
}
defer manager.Close()

// é™„åŠ ç½‘ç»œç›‘æ§ç¨‹åºåˆ°æ¥å£
err = manager.AttachNetworkMonitor("eth0")
if err != nil {
    return err
}

// è·å–ç½‘ç»œç»Ÿè®¡
stats, err := manager.GetNetworkStats()
if err != nil {
    return err
}
```

### æ•°æ®æ”¶é›†å™¨

```go
import "github.com/Haibara-Ai97/netprobe/pkg/collector"

// åˆ›å»º TC æ”¶é›†å™¨
collector := collector.NewTCCollector(manager)

// è®¾ç½®æ”¶é›†é—´éš”
collector.SetCollectInterval(5 * time.Second)

// æ‰§è¡Œä¸€æ¬¡æ•°æ®æ”¶é›†
interfaceStats, err := collector.CollectOnce()
if err != nil {
    return err
}

// æ‰“å°æ¥å£ç»Ÿè®¡
for _, stats := range interfaceStats {
    fmt.Printf("Interface %s: RX %d packets, TX %d packets\n", 
        stats.InterfaceName, stats.IngressPackets, stats.EgressPackets)
}
```

### æŒ‡æ ‡æœåŠ¡å™¨

```go
import "github.com/Haibara-Ai97/netprobe/pkg/metrics"

// åˆ›å»ºæŒ‡æ ‡æœåŠ¡å™¨
config := metrics.DefaultServerConfig()
config.Port = 8081

server := metrics.NewServer(config)

// å¯åŠ¨æœåŠ¡å™¨
go func() {
    if err := server.Start(ctx, collector); err != nil {
        log.Fatal(err)
    }
}()

// è®¿é—® http://localhost:8081/metrics æŸ¥çœ‹æŒ‡æ ‡
```

## ğŸ“Š ç›‘æ§æ•°æ®ä¸æŒ‡æ ‡

### ç½‘ç»œæµé‡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|-----|
| `netprobe_interface_rx_packets_total` | Counter | æ¥å£æ¥æ”¶æ•°æ®åŒ…æ€»æ•° |
| `netprobe_interface_tx_packets_total` | Counter | æ¥å£å‘é€æ•°æ®åŒ…æ€»æ•° |
| `netprobe_interface_rx_bytes_total` | Counter | æ¥å£æ¥æ”¶å­—èŠ‚æ€»æ•° |
| `netprobe_interface_tx_bytes_total` | Counter | æ¥å£å‘é€å­—èŠ‚æ€»æ•° |
| `netprobe_interface_rx_packets_rate` | Gauge | æ¥å£æ¥æ”¶æ•°æ®åŒ…é€Ÿç‡ (packets/sec) |
| `netprobe_interface_tx_packets_rate` | Gauge | æ¥å£å‘é€æ•°æ®åŒ…é€Ÿç‡ (packets/sec) |
| `netprobe_interface_rx_bytes_rate` | Gauge | æ¥å£æ¥æ”¶å­—èŠ‚é€Ÿç‡ (bytes/sec) |
| `netprobe_interface_tx_bytes_rate` | Gauge | æ¥å£å‘é€å­—èŠ‚é€Ÿç‡ (bytes/sec) |

### æµé‡åˆ†ææ•°æ®

```go
// ç½‘ç»œæµé‡ Key
type FlowKey struct {
    SrcIP   uint32  // æº IP åœ°å€
    DstIP   uint32  // ç›®æ ‡ IP åœ°å€
    SrcPort uint16  // æºç«¯å£
    DstPort uint16  // ç›®æ ‡ç«¯å£
    Proto   uint8   // åè®®ç±»å‹ (TCP/UDP/ICMP)
}

// æ¥å£ç»Ÿè®¡æ•°æ®
type InterfaceStats struct {
    InterfaceName      string    // æ¥å£åç§°
    InterfaceIndex     uint32    // æ¥å£ç´¢å¼•
    IngressPackets     uint64    // å…¥ç«™æ•°æ®åŒ…æ•°
    IngressBytes       uint64    // å…¥ç«™å­—èŠ‚æ•°
    EgressPackets      uint64    // å‡ºç«™æ•°æ®åŒ…æ•°
    EgressBytes        uint64    // å‡ºç«™å­—èŠ‚æ•°
    IngressPacketsRate float64   // å…¥ç«™åŒ…é€Ÿç‡
    IngressBytesRate   float64   // å…¥ç«™å­—èŠ‚é€Ÿç‡
    EgressPacketsRate  float64   // å‡ºç«™åŒ…é€Ÿç‡
    EgressBytesRate    float64   // å‡ºç«™å­—èŠ‚é€Ÿç‡
    LastUpdated        time.Time // æœ€åæ›´æ–°æ—¶é—´
}
```

### eBPF æ•°æ®ç»“æ„

```c
// æµé‡è¯†åˆ«é”® (C ç»“æ„ä½“)
struct flow_key {
    __u32 src_ip;      // æº IP åœ°å€
    __u32 dst_ip;      // ç›®æ ‡ IP åœ°å€  
    __u16 src_port;    // æºç«¯å£
    __u16 dst_port;    // ç›®æ ‡ç«¯å£
    __u8  proto;       // åè®®ç±»å‹
};

// TC è®¾å¤‡ç»Ÿè®¡é”®
struct tc_device_key {
    __u32 ifindex;     // ç½‘ç»œæ¥å£ç´¢å¼•
    __u32 direction;   // æµé‡æ–¹å‘ (0=ingress, 1=egress)
    __u32 stat_type;   // ç»Ÿè®¡ç±»å‹ (0=packets, 1=bytes)
};
```

## ğŸš§ åç»­å¼€å‘è§„åˆ’

åŸºäºå½“å‰çš„ eBPF TC ç›‘æ§åŸºç¡€ï¼ŒNetProbe å°†æ²¿ç€ä»¥ä¸‹æŠ€æœ¯è·¯çº¿å›¾å‘å±•ï¼Œæ„å»ºå®Œæ•´çš„äº‘åŸç”Ÿç½‘ç»œå¯è§‚æµ‹æ€§å¹³å°ï¼š

### ğŸ“ˆ ç¬¬ä¸€é˜¶æ®µï¼šç½‘ç»œç›‘æ§èƒ½åŠ›å¢å¼º (v0.2-v0.3)

#### 1.1 å¤šå±‚ç½‘ç»œç›‘æ§
- **XDP å±‚å¢å¼º**ï¼šå®Œå–„ç½‘å¡é©±åŠ¨å±‚æ•°æ®åŒ…æ‹¦æˆªï¼Œæä¾›æ›´é«˜æ€§èƒ½çš„åŒ…å¤„ç†èƒ½åŠ›
- **Socket å±‚ç›‘æ§**ï¼šæ·»åŠ  Socket å±‚è¿æ¥è·Ÿè¸ªï¼Œç›‘æ§åº”ç”¨å±‚ç½‘ç»œè¿æ¥çŠ¶æ€å’Œæ•°æ®ä¼ è¾“
- **Netfilter é›†æˆ**ï¼šåœ¨ Netfilter å„é“¾ (PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING) è¿›è¡Œç›‘æ§ï¼Œå®ç°ç½‘ç»œæ ˆå…¨é“¾è·¯è§‚æµ‹

#### 1.2 åè®®æ·±åº¦è§£æ
- **TCP/UDP å¢å¼º**ï¼šæ‰©å±•å½“å‰çš„åŸºç¡€åè®®è§£æï¼Œæ·»åŠ è¿æ¥çŠ¶æ€è·Ÿè¸ªã€é‡ä¼ åˆ†æã€æ‹¥å¡æ§åˆ¶ç›‘æ§
- **ICMP ç›‘æ§**ï¼šæ·»åŠ  ICMP åè®®è§£æï¼Œæ”¯æŒç½‘ç»œè¿é€šæ€§å’Œé”™è¯¯è¯Šæ–­
- **IPv6 æ”¯æŒ**ï¼šæ‰©å±•å¯¹ IPv6 åè®®çš„å®Œæ•´æ”¯æŒ
- **VLAN/MPLS æ ‡ç­¾**ï¼šæ”¯æŒå¤æ‚ç½‘ç»œç¯å¢ƒä¸­çš„æ ‡ç­¾åè®®è§£æ

### ğŸ—ï¸ ç¬¬äºŒé˜¶æ®µï¼šå®¹å™¨ç½‘ç»œæ™ºèƒ½åŒ– (v0.4-v0.5)

#### 2.1 Kubernetes æ·±åº¦é›†æˆ
- **CNI æ’ä»¶å…¼å®¹**ï¼šæ”¯æŒ Calicoã€Flannelã€Cilium ç­‰ä¸»æµ CNI æ’ä»¶çš„ç½‘ç»œç›‘æ§
- **Pod ç½‘ç»œæ‹“æ‰‘**ï¼šåŸºäº eBPF ç¨‹åºè‡ªåŠ¨å‘ç°å’Œæ„å»º Pod é—´ç½‘ç»œæ‹“æ‰‘å›¾
- **Service Mesh æ„ŸçŸ¥**ï¼šé›†æˆ Istioã€Linkerd ç­‰ Service Mesh çš„ç½‘ç»œå±‚ç›‘æ§
- **Network Policy ç›‘æ§**ï¼šå®æ—¶ç›‘æ§ Kubernetes Network Policy çš„æ‰§è¡Œæ•ˆæœ

#### 2.2 å®¹å™¨ç½‘ç»œæ€§èƒ½ä¼˜åŒ–
- **ç½‘ç»œç“¶é¢ˆè¯†åˆ«**ï¼šåŸºäºæµé‡æ¨¡å¼åˆ†æè¯†åˆ«ç½‘ç»œç“¶é¢ˆå’Œçƒ­ç‚¹
- **QoS ç›‘æ§**ï¼šç›‘æ§æœåŠ¡è´¨é‡æŒ‡æ ‡ï¼Œå¦‚å»¶è¿Ÿã€æŠ–åŠ¨ã€ä¸¢åŒ…ç‡
- **å¸¦å®½é¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹ç½‘ç»œå¸¦å®½éœ€æ±‚

### ğŸ” ç¬¬ä¸‰é˜¶æ®µï¼šç½‘ç»œæ‹“æ‰‘ä¸å¯è§†åŒ– (v0.6-v0.7)

#### 3.1 æ™ºèƒ½æ‹“æ‰‘å‘ç°
- **è‡ªåŠ¨æ‹“æ‰‘æ„å»º**ï¼šåŸºäºç½‘ç»œæµé‡è‡ªåŠ¨å‘ç°å’Œæ„å»ºç½‘ç»œæ‹“æ‰‘
- **ä¾èµ–å…³ç³»å›¾**ï¼šæ„å»ºæœåŠ¡é—´ä¾èµ–å…³ç³»å›¾å’Œé€šä¿¡è·¯å¾„
- **ç½‘ç»œåˆ†æ®µè¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«ç½‘ç»œåˆ†æ®µå’Œå®‰å…¨åŸŸè¾¹ç•Œ

#### 3.2 å¯è§†åŒ–ä¸åˆ†æ
- **å®æ—¶æ‹“æ‰‘å›¾**ï¼šWeb ç•Œé¢å±•ç¤ºå®æ—¶ç½‘ç»œæ‹“æ‰‘å’Œæµé‡çƒ­åŠ›å›¾
- **æµé‡è·¯å¾„è¿½è¸ª**ï¼šå¯è§†åŒ–æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„å®Œæ•´è·¯å¾„
- **å¼‚å¸¸å¯è§†åŒ–**ï¼šçªå‡ºæ˜¾ç¤ºç½‘ç»œå¼‚å¸¸å’Œå®‰å…¨å¨èƒ

### ğŸ›¡ï¸ ç¬¬å››é˜¶æ®µï¼šåº”ç”¨å±‚ä¸å®‰å…¨å¢å¼º (v0.8-v1.0)

#### 4.1 åº”ç”¨å±‚åè®®ç›‘æ§
- **HTTP/HTTPS è§£æ**ï¼šè§£æ HTTP è¯·æ±‚å“åº”ï¼Œç›‘æ§ API è°ƒç”¨å’Œå“åº”æ—¶é—´
- **gRPC ç›‘æ§**ï¼šæ”¯æŒ gRPC åè®®çš„è°ƒç”¨é“¾è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§
- **æ•°æ®åº“åè®®**ï¼šæ”¯æŒ MySQLã€PostgreSQLã€Redis ç­‰æ•°æ®åº“åè®®ç›‘æ§
- **æ¶ˆæ¯é˜Ÿåˆ—ç›‘æ§**ï¼šæ”¯æŒ Kafkaã€RabbitMQ ç­‰æ¶ˆæ¯ä¸­é—´ä»¶çš„ç½‘ç»œå±‚ç›‘æ§

#### 4.2 é«˜çº§å®‰å…¨åˆ†æ
- **æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹**ï¼šä½¿ç”¨ ML ç®—æ³•æ£€æµ‹å¼‚å¸¸ç½‘ç»œè¡Œä¸ºæ¨¡å¼
- **å¨èƒæƒ…æŠ¥é›†æˆ**ï¼šé›†æˆå¤–éƒ¨å¨èƒæƒ…æŠ¥ï¼Œè¯†åˆ«å·²çŸ¥æ¶æ„ IP å’ŒåŸŸå
- **é›¶æ—¥æ”»å‡»æ£€æµ‹**ï¼šåŸºäºè¡Œä¸ºåˆ†ææ£€æµ‹æœªçŸ¥ç½‘ç»œæ”»å‡»
- **è‡ªåŠ¨å“åº”æœºåˆ¶**ï¼šç»“åˆ Kubernetes Network Policy å®ç°è‡ªåŠ¨åŒ–å®‰å…¨å“åº”

### ğŸ¤– ç¬¬äº”é˜¶æ®µï¼šAI é©±åŠ¨çš„ç½‘ç»œä¼˜åŒ– (v1.1+)

#### 5.1 LLM ç½‘ç»œæ™ºèƒ½ä¼˜åŒ–
- **æ™ºèƒ½é…ç½®å»ºè®®**ï¼šåŸºäº LLM åˆ†æç½‘ç»œæ€§èƒ½æ•°æ®ï¼Œæä¾›é…ç½®ä¼˜åŒ–å»ºè®®
- **è‡ªåŠ¨æ•…éšœè¯Šæ–­**ï¼šä½¿ç”¨ AI è‡ªåŠ¨åˆ†æç½‘ç»œæ•…éšœï¼Œæä¾›ä¿®å¤å»ºè®®
- **æ€§èƒ½è°ƒä¼˜åŠ©æ‰‹**ï¼šAI é©±åŠ¨çš„ç½‘ç»œæ€§èƒ½è°ƒä¼˜å’Œå®¹é‡è§„åˆ’
- **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**ï¼šæ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢ç½‘ç»œçŠ¶æ€å’Œå†å²æ•°æ®

#### 5.2 é¢„æµ‹æ€§ç½‘ç»œè¿ç»´
- **æ•…éšœé¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®å’Œæ¨¡å¼è¯†åˆ«é¢„æµ‹ç½‘ç»œæ•…éšœ
- **å®¹é‡è§„åˆ’**ï¼šAI é©±åŠ¨çš„ç½‘ç»œå®¹é‡è§„åˆ’å’Œæ‰©å®¹å»ºè®®
- **æˆæœ¬ä¼˜åŒ–**ï¼šæ™ºèƒ½åˆ†æç½‘ç»œèµ„æºä½¿ç”¨ï¼Œæä¾›æˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆ

### ğŸ“Š æŠ€æœ¯æ¶æ„æ¼”è¿›

```
å½“å‰æ¶æ„ (v0.1)           ç›®æ ‡æ¶æ„ (v1.0+)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   eBPF TC       â”‚  -->  â”‚         AI ç½‘ç»œæ™ºèƒ½å¹³å°              â”‚
â”‚   åŸºç¡€ç›‘æ§      â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ LLM    â”‚ æœºå™¨å­¦ä¹  â”‚ é¢„æµ‹åˆ†æ â”‚ è‡ªåŠ¨åŒ– â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ åº”ç”¨å±‚åè®® â”‚ å®‰å…¨åˆ†æ â”‚ æ‹“æ‰‘å‘ç°    â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ K8s é›†æˆ   â”‚ Service Mesh â”‚ CNI    â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ XDP â”‚ TC â”‚ Socket â”‚ Netfilter      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ é‡Œç¨‹ç¢‘æ—¶é—´è¡¨

- **Q1 2025**: v0.2 - å¤šå±‚ç›‘æ§å®Œæˆ
- **Q2 2025**: v0.4 - Kubernetes æ·±åº¦é›†æˆ
- **Q3 2025**: v0.6 - ç½‘ç»œæ‹“æ‰‘å¯è§†åŒ–
- **Q4 2025**: v0.8 - åº”ç”¨å±‚åè®®æ”¯æŒ
- **Q1 2026**: v1.0 - AI é©±åŠ¨çš„ç½‘ç»œä¼˜åŒ–

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ‰©å±• eBPF ç¨‹åº

1. **æ·»åŠ æ–°çš„ Map**ï¼š
```go
// åœ¨ ebpf/network/monitor.c ä¸­æ·»åŠ æ–°çš„ Map
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(key_size, sizeof(struct custom_key));
    __uint(value_size, sizeof(__u64));
    __uint(max_entries, 1024);
} custom_stats SEC(".maps");
```

2. **æ‰©å±•ç»Ÿè®¡æ”¶é›†**ï¼š
```go
// åœ¨ pkg/collector/ ä¸­æ·»åŠ æ–°çš„æ”¶é›†å™¨
type CustomCollector struct {
    manager *ebpf.Manager
}

func (c *CustomCollector) Collect() (CustomStats, error) {
    // å®ç°è‡ªå®šä¹‰ç»Ÿè®¡æ”¶é›†é€»è¾‘
    return stats, nil
}
```

3. **æ·»åŠ æ–°æŒ‡æ ‡**ï¼š
```go
// åœ¨ pkg/metrics/ ä¸­æ³¨å†Œæ–°çš„ Prometheus æŒ‡æ ‡
var customMetric = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Name: "netprobe_custom_metric",
        Help: "Custom network metric",
    },
    []string{"interface", "direction"},
)
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

| ç»„ä»¶ | ä¼˜åŒ–ç­–ç•¥ | æ€§èƒ½å½±å“ |
|------|---------|----------|
| **eBPF Maps** | åˆç†è®¾ç½® MaxEntriesï¼Œé¿å…å“ˆå¸Œå†²çª | é«˜ |
| **æ”¶é›†é—´éš”** | æ ¹æ®ç½‘ç»œæµé‡è°ƒæ•´æ”¶é›†é¢‘ç‡ (1-10s) | ä¸­ |
| **å†…å­˜é™åˆ¶** | ç§»é™¤ rlimit é™åˆ¶ï¼Œå…è®¸å¤§å†…å­˜ä½¿ç”¨ | é«˜ |
| **åŸå­æ“ä½œ** | ä½¿ç”¨ `__sync_fetch_and_add` ä¿è¯çº¿ç¨‹å®‰å…¨ | ä¸­ |
| **æ•°æ®å¤„ç†** | æ‰¹é‡å¤„ç† Map æ•°æ®ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ | ä¸­ |

### æ•…éšœæ’æŸ¥

```bash
# æ£€æŸ¥ eBPF ç¨‹åºæ˜¯å¦æ­£ç¡®åŠ è½½
sudo bpftool prog list | grep netprobe

# æŸ¥çœ‹ eBPF Maps çŠ¶æ€
sudo bpftool map list

# æ£€æŸ¥å†…æ ¸æ—¥å¿—ä¸­çš„ eBPF ç›¸å…³é”™è¯¯
sudo dmesg | grep -i bpf

# éªŒè¯ç½‘ç»œæ¥å£æ˜¯å¦æ­£ç¡®é™„åŠ 
sudo bpftool net list

# æŸ¥çœ‹ TC ç¨‹åºé™„åŠ çŠ¶æ€
sudo tc qdisc show dev eth0
```

## ğŸ” å®‰å…¨ä¸ç”Ÿäº§è€ƒè™‘

### æƒé™è¦æ±‚
- âš ï¸ **Root æƒé™**ï¼šeBPF ç¨‹åºåŠ è½½éœ€è¦ CAP_BPF æˆ– root æƒé™
- âš ï¸ **å†…æ ¸å…¼å®¹æ€§**ï¼šç¡®ä¿ Linux å†…æ ¸ç‰ˆæœ¬ â‰¥ 4.18
- âš ï¸ **SELinux/AppArmor**ï¼šå¯èƒ½éœ€è¦é…ç½®å®‰å…¨ç­–ç•¥å…è®¸ eBPF æ“ä½œ

### èµ„æºç›‘æ§
```bash
# ç›‘æ§ eBPF ç¨‹åºå†…å­˜ä½¿ç”¨
cat /proc/sys/kernel/unprivileged_bpf_disabled

# æŸ¥çœ‹ eBPF ç¨‹åº CPU ä½¿ç”¨æƒ…å†µ
perf top -p $(pgrep netprobe-agent)

# ç›‘æ§ Map å†…å­˜å ç”¨
sudo bpftool map show | grep netprobe
```

### ç”Ÿäº§éƒ¨ç½²å»ºè®®
- ğŸ“Š **èµ„æºé™åˆ¶**ï¼šåœ¨ Kubernetes ä¸­è®¾ç½®åˆé€‚çš„ CPU/å†…å­˜é™åˆ¶
- ğŸ”„ **æ»šåŠ¨æ›´æ–°**ï¼šä½¿ç”¨ DaemonSet è¿›è¡Œæ»šåŠ¨æ›´æ–°ï¼Œé¿å…ç›‘æ§ä¸­æ–­
- ğŸ“ˆ **ç›‘æ§å‘Šè­¦**ï¼šé…ç½® Prometheus å‘Šè­¦è§„åˆ™ç›‘æ§ Agent å¥åº·çŠ¶æ€
- ğŸ” **æ—¥å¿—æ”¶é›†**ï¼šé…ç½®æ—¥å¿—æ”¶é›†å’Œåˆ†æï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

## ğŸ“š å­¦ä¹ èµ„æºä¸ç¤¾åŒº

### å®˜æ–¹æ–‡æ¡£
- [eBPF å®˜æ–¹ç½‘ç«™](https://ebpf.io/) - eBPF æŠ€æœ¯æ¦‚è¿°å’Œå­¦ä¹ èµ„æº
- [Cilium/eBPF åº“æ–‡æ¡£](https://pkg.go.dev/github.com/cilium/ebpf) - Go eBPF åº“ API æ–‡æ¡£
- [BPF å†…æ ¸æ–‡æ¡£](https://docs.kernel.org/bpf/) - Linux å†…æ ¸ BPF å­ç³»ç»Ÿæ–‡æ¡£
- [Kubernetes ç½‘ç»œæ–‡æ¡£](https://kubernetes.io/docs/concepts/cluster-administration/networking/) - K8s ç½‘ç»œåŸºç¡€

### ç›¸å…³é¡¹ç›®
- [Cilium](https://github.com/cilium/cilium) - åŸºäº eBPF çš„ç½‘ç»œå’Œå®‰å…¨è§£å†³æ–¹æ¡ˆ
- [Falco](https://github.com/falcosecurity/falco) - eBPF è¿è¡Œæ—¶å®‰å…¨ç›‘æ§
- [Pixie](https://github.com/pixie-io/pixie) - Kubernetes å¯è§‚æµ‹æ€§å¹³å°
- [Katran](https://github.com/facebookincubator/katran) - åŸºäº eBPF çš„è´Ÿè½½å‡è¡¡å™¨

### è´¡çŒ®æŒ‡å—
1. **Fork é¡¹ç›®**å¹¶åˆ›å»ºç‰¹æ€§åˆ†æ”¯
2. **ç¼–å†™æµ‹è¯•**ç¡®ä¿æ–°åŠŸèƒ½æ­£ç¡®æ€§
3. **æ›´æ–°æ–‡æ¡£**åŒ…æ‹¬ API æ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—
4. **æäº¤ PR**å¹¶å¡«å†™è¯¦ç»†çš„å˜æ›´è¯´æ˜

---

**NetProbe** è‡´åŠ›äºæ„å»ºé«˜æ€§èƒ½ã€æ˜“ç”¨çš„äº‘åŸç”Ÿç½‘ç»œç›‘æ§è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡ eBPF æŠ€æœ¯ï¼Œæˆ‘ä»¬åœ¨å†…æ ¸ç©ºé—´å®ç°é›¶æ‹·è´çš„ç½‘ç»œæ•°æ®å¤„ç†ï¼Œä¸ºäº‘åŸç”Ÿç¯å¢ƒæä¾›å®æ—¶ã€å‡†ç¡®çš„ç½‘ç»œå¯è§‚æµ‹æ€§ã€‚
