# TC ç½‘ç»œç›‘æ§åŠŸèƒ½

æœ¬æ–‡æ¡£æè¿°äº†å¦‚ä½•ä½¿ç”¨ eBPF TC (Traffic Control) ç¨‹åºè¿›è¡Œç»†ç²’åº¦çš„ç½‘ç»œç›‘æ§ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### åŸºç¡€ TC ç›‘æ§
- âœ… **åˆ†è®¾å¤‡ç»Ÿè®¡**: æŒ‰ç½‘ç»œæ¥å£åˆ†åˆ«ç»Ÿè®¡åŒ…æ•°å’Œå­—èŠ‚æ•°
- âœ… **åŒå‘ç›‘æ§**: æ”¯æŒ TC ingress å’Œ egress ç›‘æ§
- âœ… **æµé‡åˆ†ç±»**: æŒ‰æµé‡äº”å…ƒç»„è¿›è¡Œç»Ÿè®¡
- âœ… **å®æ—¶äº‹ä»¶**: é€šè¿‡ RingBuf å‘é€è¯¦ç»†äº‹ä»¶åˆ°ç”¨æˆ·ç©ºé—´

### æ”¶é›†çš„ä¿¡æ¯
- ğŸ“Š **åŸºæœ¬ç»Ÿè®¡**: åŒ…æ•°ã€å­—èŠ‚æ•°ã€æµé‡é€Ÿç‡
- ğŸ” **è®¾å¤‡ä¿¡æ¯**: ç½‘ç»œæ¥å£ç´¢å¼•ã€é˜Ÿåˆ—æ˜ å°„
- ğŸ·ï¸ **æ ‡è®°ä¿¡æ¯**: skb markã€priorityã€tc_classid
- ğŸ“¦ **æµé‡ä¿¡æ¯**: äº”å…ƒç»„ã€åè®®ç±»å‹ã€åŒ…å¤§å°

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
ç”¨æˆ·ç©ºé—´ (Go)           å†…æ ¸ç©ºé—´ (eBPF)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº       â”‚    â”‚  TC Hook ç‚¹     â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚  ç»Ÿè®¡æ”¶é›†       â”‚â—„â”€â”€â”€â”¤  tc_device_statsâ”‚
â”‚  äº‹ä»¶å¤„ç†       â”‚â—„â”€â”€â”€â”¤  tc_events      â”‚
â”‚  å¯è§†åŒ–æ˜¾ç¤º     â”‚â—„â”€â”€â”€â”¤  tc_flow_stats  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®ç»“æ„

### TC è®¾å¤‡ç»Ÿè®¡é”®
```c
struct tc_device_key {
    __u32 ifindex;      // ç½‘ç»œè®¾å¤‡ç´¢å¼•
    __u32 direction;    // 0=ingress, 1=egress
    __u32 stat_type;    // 0=packets, 1=bytes
};
```

### TC äº‹ä»¶ä¿¡æ¯
```c
struct tc_event {
    __u64 timestamp;     // æ—¶é—´æˆ³
    __u32 ifindex;       // è®¾å¤‡ç´¢å¼•
    __u32 direction;     // æ–¹å‘
    __u32 len;           // åŒ…é•¿åº¦
    __u32 mark;          // skb mark
    __u32 priority;      // ä¼˜å…ˆçº§
    __u32 queue_mapping; // é˜Ÿåˆ—æ˜ å°„
    __u32 tc_classid;    // TC ç±»åˆ«ID
    __u8  pkt_type;      // åŒ…ç±»å‹
    struct flow_key flow; // æµé‡ä¿¡æ¯
};
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç¼–è¯‘ eBPF ç¨‹åº
```bash
# ä½¿ç”¨ Makefile
make build-ebpf

# æˆ–ä½¿ç”¨è„šæœ¬
chmod +x scripts/build_ebpf.sh
./scripts/build_ebpf.sh
```

### 2. è¿è¡Œç›‘æ§ç¨‹åº
```bash
# ç¼–è¯‘ç¤ºä¾‹ç¨‹åº
go build -o bin/tc_monitor examples/tc_monitor_example.go

# è¿è¡Œç›‘æ§ (éœ€è¦ root æƒé™)
sudo ./bin/tc_monitor eth0
```

### 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
ç¨‹åºä¼šæ¯ 5 ç§’æ˜¾ç¤ºä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯ï¼š
```
ğŸ“ˆ Traffic Statistics:
==================================================
Global Statistics:
  RX Packets  : 1234
  TX Packets  : 987
  RX Bytes    : 1.23 MB
  TX Bytes    : 987.45 KB

TC Device Statistics:
  Interface eth0:
    Ingress Packets: 567
    Ingress Bytes  : 678.90 KB
    Egress Packets : 432
    Egress Bytes   : 543.21 KB
==================================================
```

## ğŸ”§ TC ç¨‹åºé™„åŠ 

TC ç¨‹åºéœ€è¦ä½¿ç”¨ tc å‘½ä»¤æ‰‹åŠ¨é™„åŠ ï¼š

### Egress ç›‘æ§
```bash
# åˆ›å»º clsact qdisc
sudo tc qdisc add dev eth0 clsact

# é™„åŠ  egress ç¨‹åº
sudo tc filter add dev eth0 egress bpf object-file bin/ebpf/network-monitor.o section tc
```

### Ingress ç›‘æ§
```bash
# é™„åŠ  ingress ç¨‹åº
sudo tc filter add dev eth0 ingress bpf object-file bin/ebpf/network-monitor.o section tc
```

### æ¸…ç†
```bash
# ç§»é™¤ TC ç¨‹åº
sudo tc qdisc del dev eth0 clsact
```

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### é‡‡æ ·ç­–ç•¥
- ç»Ÿè®¡ä¿¡æ¯å®æ—¶æ›´æ–°
- è¯¦ç»†äº‹ä»¶ä½¿ç”¨ 1/256 é‡‡æ ·ç‡å‡å°‘å¼€é”€
- å¯æ ¹æ®éœ€è¦è°ƒæ•´é‡‡æ ·ç‡

### Map å¤§å°
- `tc_device_stats`: 1024 æ¡ç›® (æ”¯æŒå¤šè®¾å¤‡)
- `tc_flow_stats`: 10240 æ¡ç›® (æµé‡ç»Ÿè®¡)
- `tc_events`: 8MB RingBuf (äº‹ä»¶ç¼“å†²)

## ğŸ“ å­¦ä¹ ä»·å€¼

è¿™ä¸ªå®ç°å±•ç¤ºäº†å¯¹ä»¥ä¸‹æ¦‚å¿µçš„æ·±åº¦ç†è§£ï¼š

### Linux ç½‘ç»œæ ˆ
- TC å­ç³»ç»Ÿå·¥ä½œåŸç†
- åŒ…åœ¨ç½‘ç»œæ ˆä¸­çš„è·¯å¾„
- QoS å’Œæµé‡æ§åˆ¶æœºåˆ¶

### eBPF æŠ€æœ¯
- TC Hook ç‚¹çš„ä½¿ç”¨
- Map ç±»å‹å’Œæ•°æ®å…±äº«
- é«˜æ•ˆçš„å†…æ ¸ç¼–ç¨‹æŠ€å·§

### ç³»ç»Ÿç›‘æ§
- ç»†ç²’åº¦æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å®æ—¶æ•°æ®å¤„ç†
- ç½‘ç»œæ•…éšœè¯Šæ–­

## ğŸš¦ åç»­æ‰©å±•

å¯ä»¥è¿›ä¸€æ­¥æ‰©å±•çš„åŠŸèƒ½ï¼š
- é˜Ÿåˆ—å»¶è¿Ÿç›‘æ§
- ä¸¢åŒ…åŸå› åˆ†æ
- å¸¦å®½é™åˆ¶æ•ˆæœè¯„ä¼°
- æµé‡æ•´å½¢ç›‘æ§
- å¼‚å¸¸æ¨¡å¼æ£€æµ‹
